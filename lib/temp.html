<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <style>
      #main {
        margin: auto;
        text-align: center;
      }
      
      nav {
        margin: 20px 0 20px 0;
        font-size: 2em;
      }
      
      nav a{
        text-decoration: none;
      }
    
      nav a + a:before{
        content: " / ";
      }
    </style>
  </head>
  <body>
    <div id='main'>
    
      <div id='period'>
        form: <select id='select-period-from'></select> to: <select id='select-period-to'></select> <input type='button' value='generate'/></br>
      </div>
      
      <div id='categories'>
        <select id='select-file'></select></br>
      </div>
      
      <div id='months'>
         year: <select id='select-year'></select></br>
      </div>
      
    </div>
      
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/Chart.js/1.0.2/Chart.js"></script>
    
    <script>
      /*
       * basic setting
       */
      var h_scale_wd = 25;
      var pointHitDetectionRadius = h_scale_wd / 2 * 0.9;
      
      function compute_width(h_scale_count){
        return h_scale_count * h_scale_wd / window.screen.width * 100
      }
      
      var $main = $('#main');

      var line_config = {
        fillColor: "rgba(220,220,220,0.2)",
        strokeColor: "rgba(220,220,220,1)",
        pointColor: "rgba(220,220,220,1)",
        pointStrokeColor: "#fff",
        pointHighlightFill: "#fff",
        pointHighlightStroke: "rgba(220,220,220,1)",
      };
      
      var bar_config = {
        fillColor: "rgba(220,220,220,0.5)",
        strokeColor: "rgba(220,220,220,0.8)",
        highlightFill: "rgba(220,220,220,0.75)",
        highlightStroke: "rgba(220,220,220,1)"
      };
      
      // extend jQuery
      (function($){
        $.fn.extend({
          addOpts : function(items_list){
            var $that = this;
            items_list.forEach(function(i){
              $that.append('<option value ="' + i +'">' + i +'</option>');
            });
            return $that;            
          }
        });
      })(jQuery);
      
      // init nav
      (function($){
        var $nav = $('<nav/>');
        $('#main > div').each(function(){
          $nav.append('<a href="#' + this.id +'">' + this.id +'</a>')
        });
        $main.prepend($nav);
      })(jQuery);
      
    </script>
    
    <% bmfl = BookmarkFile.all.order(name: :asc)%>
    
    <script>
      var period_labels = <%=bmfl.map { |f| f.name}%>
      var statistic = <%=bmfl.map { |f| f.category.links(:r).size } %>
      var data = {
          labels: period_labels ,
          datasets: [ $.extend({}, line_config, {data: statistic })]
      };
      
      $('#period canvas').remove();
      var $chart = $('<canvas/>');
      $('#period').append($chart);
      var wd = compute_width(period_labels.length)
      $chart.width(wd + '%');
      if(wd < 100) $chart.height('500px');
      var ctx = $chart[0].getContext("2d");
      var myNewChart = new Chart(ctx).Line(data, {bezierCurve: false, pointHitDetectionRadius : pointHitDetectionRadius});
      
      $('#select-period-from').addOpts(period_labels);
      $('#select-period-to').addOpts(period_labels.reverse());
      period_labels.reverse();
      
    </script>
    
    <script>
      var categories_of_files = {
        <% bmfl.each do |f| %>
          <%= f.name %> : {
            lbs : <%= f.category.categories[0].categories(:r).map { |c| (c.path.map { |p| p.name }).join(' / ') }%> ,
            dt : <%= f.category.categories[0].categories(:r).map { |c| c.links.size }%>
           },
        <% end %>
      };
      
      var k = Object.keys(categories_of_files);
      k.reverse();
      $('#select-file').addOpts(k);
      
      var labels = <%=bmfl[-1].category.categories[0].categories(:r).map { |c| (c.path.map { |p| p.name }).join(' / ') }%>
      var statistic = <%=bmfl[-1].category.categories[0].categories(:r).map { |c| c.links.size }%>
      var data = {
          labels: labels ,
          datasets: [ $.extend({}, bar_config, {data: statistic })]
      };
      

      var $chart = $('<canvas/>');
      $('#categories').append($chart);
      var wd = compute_width(labels.length);
      $chart.width(wd + '%');
      if(wd < 100) $chart.height('500px');
      var ctx = $chart[0].getContext("2d");
      var myNewChart = new Chart(ctx).Bar(data);
      
    </script>
    
    <script>      
      
      
      <% months_hash = Hash.new(0) %>
      <% months_arr = bmfl[-1].category.links(:r).map { |l| l.add.year.to_s + '/' + l.add.month.to_s.sub(/^(\d)$/,'0\1') } %>
      <% months_arr.each { |m| months_hash[m] = months_hash[m] + 1 } %>
      <% months_sort_arr = months_hash.sort %>
      
      var labels = <%= months_sort_arr.map { |e| e[0] } %>;
      var statistic = <%= months_sort_arr.map { |e| e[1] } %>;
      
      var select_m = {};      
      labels.forEach(function(e){
        select_m[e.replace(/\/.*$/,'')] = null;
      });
      
      var k = Object.keys(select_m);
      k.reverse();
      $('#select-year').addOpts(k);      
      
      var data = {
          labels: labels ,
          datasets: [ $.extend({}, bar_config, {data: statistic })]
      };
      
      
      var $chart = $('<canvas/>');
      $('#months').append($chart);
      var wd = compute_width(labels.length);
      $chart.width(wd + '%');
      if(wd < 100) $chart.height('500px');
      var ctx = $chart[0].getContext("2d");
      var myNewChart = new Chart(ctx).Bar(data);
      
    </script>
  </body>
</html>
